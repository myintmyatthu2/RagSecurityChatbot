<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SecuritasBotMM</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='homestyle.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div id="overlay" class="overlay"></div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="logo" style="text-align: center;">
      <img src="{{ url_for('static', filename='images/Logo.png') }}" alt="Logo" width="100%">
      SecuritasBotMM
    </div>
    <button id="newChatBtn">+ New Session</button>
    <button id="themeToggle">🌙 Dark Mode</button>
    <h3>History</h3>
    <ul id="chatHistory"></ul>
  </div>

  <!-- Main content -->
  <div class="chat-container">
    <header>
      <span id="toggleSidebar" class="nav-toggle">☰</span>
      <h2>SecuritasBotMM</h2>
    </header>

    <div id="chatBox" class="chat-box"></div>

    <div class="input-area">
      <input type="text" id="userInput" placeholder="Enter your command or query..." />
      <button id="sendBtn">➤</button>
    </div>
    <div style="height: 20px;" class="fo"></div>
  </div>

<script>
// ---------------- Sidebar toggle -----------------
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");
const toggleSidebar = document.getElementById("toggleSidebar");

// Show sidebar on toggle
toggleSidebar.onclick = () => {
  sidebar.classList.add("active");
  overlay.classList.add("active");
};

// Hide sidebar when clicking overlay
overlay.onclick = () => {
  sidebar.classList.remove("active");
  overlay.classList.remove("active");
};

// ---------------- Dark/Light Mode -----------------
const themeBtn = document.getElementById("themeToggle");
if(localStorage.getItem("theme") === "dark"){
  document.body.classList.add("dark-mode");
  themeBtn.textContent = "☀️ Light Mode";
}
themeBtn.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  if(document.body.classList.contains("dark-mode")){
    themeBtn.textContent = "☀️ Light Mode";
    localStorage.setItem("theme","dark");
  } else {
    themeBtn.textContent = "🌙 Dark Mode";
    localStorage.setItem("theme","light");
  }
});

// ---------------- Chat Sessions -----------------

localStorage.removeItem("CyberSecSessions");

let sessions = [[]];
let activeSessionIndex = 0;

function saveSessions(){
  localStorage.setItem("CyberSecSessions",JSON.stringify(sessions));
  renderHistory();
}

function renderHistory(){
  const history = document.getElementById("chatHistory");
  history.innerHTML = "";

  sessions.forEach((sess,index)=>{
    const li = document.createElement("li");
    li.className = index===activeSessionIndex ? "active" : "";

    // Session title div
    const titleDiv = document.createElement("div");
    titleDiv.className = "session-title";
    titleDiv.textContent = `${sess.find(m => m.type==="user")?.text.slice(0,20) || "New Session"} (${sess.length})`;
    titleDiv.onclick = ()=> {
      activeSessionIndex = index;
      renderChat();
      renderHistory();
      if(window.innerWidth < 768){
        sidebar.classList.remove("active");
        overlay.classList.remove("active");
      }
    };

    // Menu container
    const menuDiv = document.createElement("div");
    menuDiv.className = "menu-container";

    const menuBtn = document.createElement("span");
    menuBtn.className = "menu-btn";
    menuBtn.textContent = "…";
    menuBtn.onclick = (e)=>{
      e.stopPropagation();
      document.querySelectorAll('.menu-container.show').forEach(el=>{
        if(el!==menuDiv) el.classList.remove('show');
      });
      menuDiv.classList.toggle("show");
    };

    const deleteOption = document.createElement("div");
    deleteOption.className = "delete-option";
    deleteOption.textContent = "Delete";
    deleteOption.onclick = (e)=>{
      e.stopPropagation();
      if(confirm("Are you sure you want to delete this session?")){
        sessions.splice(index,1);
        if(activeSessionIndex >= sessions.length) activeSessionIndex = sessions.length-1;
        saveSessions();
        renderChat();
      }
    };

    menuDiv.appendChild(menuBtn);
    menuDiv.appendChild(deleteOption);

    li.appendChild(titleDiv);
    li.appendChild(menuDiv);
    history.appendChild(li);
  });
}

document.addEventListener('click', ()=>{
  document.querySelectorAll('.menu-container.show').forEach(el=>{
    el.classList.remove('show');
  });
});

function renderChat(){
  const chatBox = document.getElementById("chatBox");
  chatBox.innerHTML = "";

  sessions[activeSessionIndex].forEach(msg => {
    const container = document.createElement("div");
    container.className = "message-container " + (msg.type==="user"?"user-container":"bot-container");

    const div = document.createElement("div");
    div.className = "message " + (msg.type==="user"?"user":"bot");

    // Render HTML for bot messages, plain text for user
    if(msg.type === "bot") {
      div.innerHTML = msg.text; // ✅ renders HTML
    } else {
      div.textContent = msg.text; // user messages remain safe
    }


    const timeSpan = document.createElement("span");
    timeSpan.className = "message-time";
    timeSpan.textContent = msg.time;

    container.appendChild(div);
    container.appendChild(timeSpan);
    chatBox.appendChild(container);
  });

  chatBox.scrollTop = chatBox.scrollHeight;
}
async function sendMessage(){
  const input = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const text = input.value.trim();
  if(!text) return;

  const now = new Date();
  const timeString = now.toLocaleTimeString('en-US', { hour12: false });

  // Add user message
  sessions[activeSessionIndex].push({type:"user", text, time: timeString});
  input.value = "";
  renderChat();
  saveSessions();

  // Disable input + button
  input.disabled = true;
  sendBtn.disabled = true;

  // Add typing animation with icon
  const loadingMsg = {
    type: "bot",
    text: `
      <div class="typing-with-icon">
      <span class="typing-icon">🤖</span>
        <span class="typing-dots">Just a moment</span>
      </div>
    `,
<!--    time: timeString,-->
    temp: true
  };
  sessions[activeSessionIndex].push(loadingMsg);
  renderChat();

  try {
    const response = await fetch("/api/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        prompt: text,
        session_id: activeSessionIndex
      })
    });
    const data = await response.json();

    // Remove temporary animation
    sessions[activeSessionIndex] = sessions[activeSessionIndex].filter(m => !m.temp);

    const botTime = new Date().toLocaleTimeString('en-US', { hour12: false });
    if(data.thinking){
      sessions[activeSessionIndex].push({type:"bot", text:data.thinking, time:botTime});
    }
    sessions[activeSessionIndex].push({type:"bot", text:data.answer, time:botTime});
    renderChat();
    saveSessions();
  } catch {
    sessions[activeSessionIndex] = sessions[activeSessionIndex].filter(m => !m.temp);

    const errorTime = new Date().toLocaleTimeString('en-US', { hour12: false });
    sessions[activeSessionIndex].push({type:"bot", text:"⚠️ Connection error", time: errorTime});
    renderChat();
    saveSessions();
  } finally {
    input.disabled = false;
    sendBtn.disabled = false;
    input.focus();
  }
}

// ---------------- Events -----------------
document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("userInput").addEventListener("keypress", e=>{if(e.key==="Enter") sendMessage();});
document.getElementById("newChatBtn").onclick = ()=>{
  sessions.push([]);
  activeSessionIndex = sessions.length-1;
  saveSessions();
  renderChat();
};

renderHistory();
renderChat();

let inactivityTimer;
function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    location.reload();
  }, 5 * 60 * 1000);
}
["click", "mousemove", "keypress", "scaqroll", "touchstart"].forEach(evt => {
  document.addEventListener(evt, resetInactivityTimer);
});
resetInactivityTimer();
  document.getElementById("newChatBtn").onclick = ()=>{
  sessions.push([]);
  activeSessionIndex = sessions.length-1;
  saveSessions();
  renderChat();
};

// ---------------- Intro message -----------------
if (sessions[activeSessionIndex].length === 0) {
  const introTime = new Date().toLocaleTimeString('en-US', { hour12: false });

  sessions[activeSessionIndex].push({
    type: "bot",
    text: `👋 Hello! I’m SecuritasBotMM. I assist Myanmar youth in understanding and navigating online safety by addressing:<br>
• Online threats: scams, phishing, cyberbullying<br>
• Data protection: privacy tips, GDPR basics<br>
• Legal guidance: Myanmar Privacy Law (2017), Cybersecurity Law (2025), Electronic Transactions Law, Telecommunications Law<br>
• Bilingual support: answers in Myanmar and English<br>
• Interactive learning: quizzes to test and improve your cybersecurity knowledge`,
    time: introTime
  });

  saveSessions();
}



renderHistory();
renderChat();

</script>
</body>
</html>
